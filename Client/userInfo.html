<html>
    <head>
        <link rel="stylesheet" href="Style.css"/>
        <title>User Information</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    </head>
    <body onload="loadPage()">
        <nav>
            <ul class="nav-list">
                <li><a href="./userInfo.html">Home</a></li>
                <li><a href="./employee.html">Shifts</a></li>
                <!-- <li><a href="#contact">Contact</a></li> -->
                <!-- <li><a id="Admin" href="#Admin" hidden>Admin</a></li> -->
                <li><a href="./LogOutPage.html">Log-out</a></li>
            </ul>
        </nav>
        <h1 class="custom-heading-h1">Plastic Factory</h1>
        <h3 class="custom-heading-h3-h4" id="title">Employee details</h3><br>
        
        <div class="box" style="width:350px;">
            <label id="name" style="font-size: 16px;" for="">Employee's name:</label><br><br>
            <label id="department" style="font-size: 16px;" for="">Department:</label><br><br>
            <label id="manager" style="font-size: 16px;" for="">Department manager:</label><br><br>
            <label id="action" style="font-size: 16px;" for="">Action left for tody:</label><br>
        </div>
        <div id="admin" hidden="true">
            <h4 class="custom-heading-h3-h4" id="title">Your department employees</h3><br>

            <table border="1" style="border-collapse: initial;" id="table">
                <tr>
                    <th>
                        <label class="label-table" for="Name">Name</label>
                    </th>
                    <th>
                        <label class="label-table" for="Email">email</label>
                    </th>
                    <th>
                        <label class="label-table" for="Phone">phone</label>
                    </th>
                    <th>
                        <label class="label-table" for="Action">Action left</label>
                    </th>
                </tr>
            </table>
            
        </div>
    
    </body>
    
    <script>
        async function loadPage(){
            const token = localStorage.getItem("token");
            if(!token) {
                alert("token not provided")
                window.location.href = "./login.html"
            }

            //get request to get the employee data
            const resp = await fetch("http://localhost:8000/employee",{headers: { token: token }})
            const {data} = await resp.json()
            console.log("data:\n",data)
            
            if(data.employeeActionsLeft===0){
                alert("You have no actions left for today")
                window.location.href = "./login.html"
            }
            const name = document.getElementById("name")
            const department = document.getElementById("department")
            const manager = document.getElementById("manager")
            const action = document.getElementById("action")

            name.innerText += " " + data.employeeName
            department.innerText += " " + data.Departmenat
            manager.innerText += " " + data.departmentManager
            action.innerText += " " + data.employeeActionsLeft

            if(data.departmentManager === data.employeeName) {                
                document.getElementById("admin").hidden=false
                const resdepartment = await fetch("http://localhost:8000/employee/department",{headers: { token: token }})
                const {data: datadepartment} = await resdepartment.json()

                const table = document.getElementById("table")
                newTr = document.createElement("tr")
                for(element of datadepartment.employees){
                    
                    const fullName = element.First_Name + " " + element.Last_Name
                    if(data.departmentManager !== fullName){

                        //create the row
                        const newTr = document.createElement("tr")

                        //Create the Columns
                        const nameEmployeeTd = document.createElement("td") 
                        const emailTd = document.createElement("td")
                        const phoneTd = document.createElement("td")
                        const actionTd = document.createElement("td")
                        // const Edit = document.createElement("td")

                        //get the user info
                        let responsUser = await fetch(`http://localhost:8000/employee/user/${element.id}`)
                        let {data: infoEmployee} = await responsUser.json()
                        // console.log(infoEmployee)
                        
                        let responsDATA = await fetch(`http://localhost:8000/employee/info/${infoEmployee.userName}`)
                        let {data: dataUser} = await responsDATA.json()
                        // console.log(dataUser)

                        //fill the columns
                        nameEmployeeTd.innerText = fullName
                        emailTd.innerText = dataUser.email
                        phoneTd.innerText = dataUser.phone
                        actionTd.innerText = infoEmployee.employeeActionsLeft

                        //append the columns to the row
                        newTr.appendChild(nameEmployeeTd)
                        newTr.appendChild(emailTd)
                        newTr.appendChild(phoneTd)
                        newTr.appendChild(actionTd)
                        newTr.appendChild(funcEdit(element.id))

                        //append the row to the table
                        table.appendChild(newTr)
                    }
                    else continue
                    // employeeActionsLeft: user.Num_of_actions,
                    // Departmenat:Department.Name,
                    // shifts: shifts,

                };
            }
        }

        function funcEdit(id){
            const Edit = document.createElement("td")
            const button = document.createElement("button")
            button.innerText = "More information"
            button.onclick = function(){
                window.location.href = `./AdminEdit.html?id=${id}`
            }
            Edit.appendChild(button)
            return Edit
        }

        async function getdmployee(){
            const respons = await fetch("http://localhost:8000/employee/user")
            let {infoEmployee} = await respons.json()
            return infoEmployee
        }
    </script>
</html>