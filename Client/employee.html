<html>
    <head>
        <link rel="stylesheet" href="Style.css"/>
        <title>Employees Information</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    </head>

    <body onload="loadPage()">
        <nav>
            <ul class="nav-list">
                <li><a href="./userInfo.html">Home</a></li>
                <li><a href="./employee.html">Shifts</a></li>
                <!-- <li><a href="#contact">Contact</a></li> -->
                <li><a href="./LogOutPage.html">Log-out</a></li>
            </ul>
        </nav>
        <h1 class="custom-heading-h1">Plastic Factory</h1>
        <h3 class="custom-heading-h3-h4" id="title"></h3><br>
        <h4 class="custom-heading-h3-h4" id="department" style="font-size: 15px;">works in the ** department</h4>
        <h4 class="custom-heading-h3-h4" id="manager" style="font-size: 15px;">Department manager **</h4>
        
        <h4 class="custom-heading-h3-h4" style="font-size: 15px;">Your shifts this month</h4>
        <table border="1" style="border-collapse: initial;" id="table">
            <tr>
                <th>
                    <label class="label-table" for="Date">Date</label>
                </th>
                <th>
                    <label class="label-table" for="Start time">Start time</label>
                </th>
                <th>
                    <label class="label-table" for="End time">Start time</label>
                </th>
                <th>
                    <label class="label-table" for="total time">Summary of hours</label>
                </th>
            </tr>
        </table>
        <br>

        <button onclick="addPage()">Add Shift</button>

        <h4 id="totalTime" class="custom-heading-h3-h4" style="font-size: 15px;">Total all the time you worked this month: </h4>
        <h4 id="actions" class="custom-heading-h3-h4" style="font-size: 15px;">The number of actions you have left are: </h4>
        
    </body>

    <script>
        
    async function loadPage(){
        
        try{
            //get the token
            const token = localStorage.getItem("token");
            if(!token) {
                    alert("token not provided")
                    window.location.href = "./login.html"
                }
            //get request to get the employee data
            const resp = await fetch("http://localhost:8000/employee",{headers: { token: token }})
            const {data} = await resp.json()
            console.log(data)
            if(data.employeeActionsLeft === 0){
                alert("You have no actions left")
                window.location.href = "./login.html"
            }

            const title = document.getElementById("title")
            title.innerText = "wellcom back " + data.employeeName

            //Displaying the name of the department
            const department = document.getElementById("department")
            department.innerHTML = department.innerHTML.replace("**", `${data.Departmenat}`);

            //Displaying the name of the department
            const manager = document.getElementById("manager")
            manager.innerHTML = manager.innerHTML.replace("**", `${data.departmentManager}`);

            const actions = document.getElementById("actions")
            actions.innerText += data.employeeActionsLeft
            table = document.getElementById("table")
            let TotalWorkTime = 0
            const totalTime = document.getElementById("totalTime")

            const user = await fetch("http://localhost:8000/employee",{headers: { token: token }})

            // for (const elem of data.shifts) {
            data.shifts.forEach((elem, index) => {

                    // new row 
                    const newTr = document.createElement("tr")

                    // create new cells
                    const tdDate = document.createElement("td")
                    const tdStartTime = document.createElement("td")
                    const tdEndTime = document.createElement("td")
                    const tdTotalTime = document.createElement("td")
                    const tdEdit = document.createElement("td")
                    const tdDeleted = document.createElement("td")


                    const editFunc = () => {
                            // Create a new button edit
                            const button = document.createElement("button")

                            // Set the button's text content
                            button.textContent = "Edit";
                            // Optionally, add an event listener to the button
                            button.addEventListener("click", function() {window.location.href = `./EditShift.html?indexShift=${index}`});

                            return button
                    }

                    // fild the elem
                    tdDate.innerHTML = elem.Date
                    tdStartTime.innerText = elem.Start_Time 
                    tdEndTime.innerText = elem.End_Time

                    const totalTimeForDay = calctotal(elem.Start_Time,elem.End_Time)
                    
                    // Split the text into word
                    const words = totalTimeForDay.split(" ")

                    // Create two new strings based on the split index
                    tdTotalTime.innerText = words.slice(0, 4).join(" ")
                    TotalWorkTime += Number(words.slice(4).join(" "))

                    tdEdit.appendChild(editFunc())
                    tdDeleted.appendChild(deleteFunc(index,token))

                    newTr.appendChild(tdDate)
                    newTr.appendChild(tdStartTime)
                    newTr.appendChild(tdEndTime)
                    newTr.appendChild(tdTotalTime)
                    newTr.appendChild(tdEdit)
                    newTr.appendChild(tdDeleted)

                    table.appendChild(newTr)
            })

            const hours=Math.floor(TotalWorkTime/60)
            const minutes=TotalWorkTime%60
            totalTime.innerText += `${hours} hours ${minutes} minutes`
    }
    catch(e){
        console.log({erorr:e})
        window.location.href = `./login.html`
        }
    }

    const deleteFunc = (index, token) =>{
        // Create a new button delete
        const button = document.createElement("button")
                    
        // Set the button's text content
        button.textContent = "delete";
        button.addEventListener("click",async function() {
        //remove this shift from the table
            const options = {
                    method: 'DELETE',       
                    headers: {'Content-Type': 'application/json', token: token},

                    // Convert the data to a JSON string
                    body: JSON.stringify({index:index}) 
                    }
                        
                        const resp = await fetch(`http://localhost:8000/employee/shift`, options); // Make the DELETE request
                        const {data} = await resp.json()
                        console.log(data)
                        window.location.reload(); // to refres the page           
                    });

                    return button
            }

    function calctotal(start,end){

        // Split start and end times into hours and minutes
        const [startHour, startMinute] = start.split(':').map(Number);
        const [endHour, endMinute] = end.split(':').map(Number);

        // Calculate total minutes from midnight
        const startTimeInMinutes = startHour * 60 + startMinute;
        const endTimeInMinutes = endHour * 60 + endMinute;
        
        // Calculate the difference in minutes
        let timeDiffInMinutes = endTimeInMinutes - startTimeInMinutes;

        if (timeDiffInMinutes < 0) {
            timeDiffInMinutes += 24 * 60; // Add 24 hours worth of minutes to handle negative differences
        }

        // Convert total minutes difference to hours and minutes
        let hours = Math.floor(timeDiffInMinutes / 60);
        let minutes = timeDiffInMinutes % 60;

        return `${hours} hours ${minutes} minutes ${hours*60+minutes}`;
        }

    function addPage(){
        window.location.href = `./addShift.html`
    }
    </script>

</html>