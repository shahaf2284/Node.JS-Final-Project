<html>
    <head>
        <link rel="stylesheet" href="Style.css"/>
        <title>Edit Shift</title>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    </head>
    <body onload="loadPage()">
        <h1 class="custom-heading-h1">Plastic Factory</h1>
        <h3 class="custom-heading-h3-h4" id="title">Hi ** would you like to do the shift</h3><br>
        
        <div class="box" >
                <label for="Date" style="font-size: 17px;">Date</label>
                <input id="Date" class="EditeSifts" type="date"><br>
        
                <label for="Start time" style="font-size: 17px;">Start time</label>
                <input id="Stime" class="EditeSifts" type="time" onchange="checkInputs()"><br>
        
                <label for="End time" style="font-size: 17px;">End time</label>
                <input id="Etime" class="EditeSifts" type="time" onchange="checkInputs()"><br><br>
                
                <button id="submitButton" onclick="Update()" disabled>Update</button>
        </div>

    </body>
    <script>

        async function loadPage(){
            //get the token
            const token = localStorage.getItem("token");
            if(!token) {
                alert("token not provided")
                window.location.href = "./login.html"
            }

            const params = new URLSearchParams(window.location.search);

            const index = params.get('indexShift')

            //get request to get the employee data
            const resp = await fetch("http://localhost:8000/employee",{headers: { token: token }})

            const {data} = await resp.json()

            console.log(data.shifts[index])

            const title = document.getElementById("title")
            title.innerHTML = title.innerHTML.replace("**", `${data.employeeName}`)

            const Date = document.getElementById("Date")
            const Stime = document.getElementById("Stime")
            const Etime = document.getElementById("Etime")

            //Initialize the appropriate field in the existing information 
            Date.value = InputdateArrange(data.shifts[index].Date)
            Stime.value = InputimeArrange(data.shifts[index].Start_Time)
            Etime.value = InputimeArrange(data.shifts[index].End_Time)
            
            // disabled the button
            submitButton.disabled = true;
            submitButton.enabled = false;
        }

        function checkInputs(){
            const Stime = document.getElementById("Stime").value
            const Etime = document.getElementById("Etime").value
            const submitButton = document.getElementById("submitButton")

            const [Start_hours,Start_minutes] = Stime.split(":")
            const [End_hours,End_minutes] = Etime.split(":")

            if(Number(End_hours) > Number(Start_hours) || 
                (Number(End_hours) === Number(Start_hours) && Number(End_minutes)>Number(Start_minutes))){
            
                // Enable the button
                submitButton.disabled = false;
                // Add the 'enabled' class
                submitButton.classList.add('enabled');
            }
        }

        async function Update(){
            const token = localStorage.getItem("token")

            const params = new URLSearchParams(window.location.search);
            const index = params.get('indexShift')
            
            const date = document.getElementById("Date").value
            const Stime = document.getElementById("Stime").value
            const Etime = document.getElementById("Etime").value
            const updShift = {Date:outputDateArrange(date), Start_Time:outputTimeArrange(Stime),End_Time:outputTimeArrange(Etime)}

            const options = {
                headers: { token: token },
                method: 'PUT', // HTTP method
                headers: {
                    'Content-Type': 'application/json', // Specify the content type
                    token: token
                },
                body: JSON.stringify(updShift)  // Convert the data to a JSON string
            };
            
            const resp = await fetch(`http://localhost:8000/employee/EditShift/indexShift=${index}`, options); // Make the PUT request
            const {data} = await resp.json()
            console.log(data)

            // // disabled the button
            // submitButton.disabled = true;
            // submitButton.enabled = false;
            window.location.href = `./employee.html`

        }

        function outputDateArrange(Date){

            const words = Date.split("-")
            return words[2] + "-" + words[1] + "-" +  String(Number(words[0])-2000)
        }
        
        function outputTimeArrange(Time){

            const words = Time.split(":")

            if(Number(words[0]) < 10 && words[0].length === 2) {words[0] = words[0][0]}
            if(Number(words[1])< 10 && words[1].length === 2) {words[1] = words[1][0]}

            return words[0] + ":" + words[1]
        }

        function InputdateArrange(Date){

            const words = Date.split("-")
            return "20" + words[2] + "-" + words[1] + "-" + words[0]

        }

        function InputimeArrange(Time){
            const words = Time.split(":")
            if(Number(words[0]) < 10 && words[0].length < 2) {words[0] = '0' + words[0]}
            if(Number(words[1]) < 10 && words[1].length < 2) {words[1] = '0' + words[1]}
            
            return words[0] + ":" + words[1]
        }

    </script>
</html>